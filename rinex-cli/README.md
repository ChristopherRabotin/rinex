RINEX-cli 
=========

Command line tool to parse, analyze and manage RINEX files.  

[![crates.io](https://img.shields.io/crates/v/rinex-cli.svg)](https://crates.io/crates/rinex-cli)
[![License](https://img.shields.io/badge/license-Apache%202.0-blue?style=flat-square)](https://github.com/gwbres/rinex/blob/main/LICENSE-APACHE)
[![License](https://img.shields.io/badge/license-MIT-blue?style=flat-square)](https://github.com/gwbres/rinex/blob/main/LICENSE-MIT) 

The first purpose of this tool is to expose the [library](https://github.com/gwbres/rinex/rinex) 
in a high level and easy to use fashion.  
The application will be able to parse all RINEX formats supported by the library, refer to its documentation.

The application knows a few `teqc` operations, refer to the
[dedicated paragraph](https://github.com/gwbres/rinex/edit/main/rinex-cli/README.md#teqc-operations)
down below.

This tool will eventually be able to perform most common RINEX processing.

## File formats

The application can parse and produce all formats supported by the [library](https://github.com/gwbres/rinex) 

### File naming conventions

File names are disregarded by these tools, you can analyze
& parse files that do not follow naming conventions.

When producing data, this tool will eventually help the user to generate RINEX that follows
naming conventions, but that is currently under development.

### Compressed data

This tool supports gzip compressed files, as long as their name is terminated
by `.gz`, so it can detect the need of invoking the decompression routine.

This tool also supports `CRINEX` (V1, v3) natively, as these declinations
are amonsgt supported formats

## `teqc` operations

`teqc` is a well known application to process RINEX.  

Unlike `teqc`, this application is not capable of processing Binary RINEX ("BINEX") and 
proprietary formats in general.

Here is the list of operations that this tool is capable of performing,
that usually people use `teqc` almost exclusively to perform, to this day

- [merge](https://github.com/gwbres/rinex/edit/main/rinex-cli/README.md#merge)
several RINEX toghether into a single file.

- [decimate](https://github.com/gwbres/rinex/edit/main/rinex-cli/README.md#decimate)
RINEX record to reduce the quantity of data to analyze

- [split](https://github.com/gwbres/rinex/edit/main/rinex-cli/README.md#split)
given file(s) into two

- [ascii-plot](https://github.com/gwbres/rinex/edit/main/rinex-cli/README.md#ascii-plot)
to print a very descriptive tiny plot in the terminal,
as contained in reports generated by `teqc`

## Graphical view

Graphical view is currently under development is not available at the moment. 
Only terminal / stdout visualization exists to this day.

## Getting started

This application is managed by `cargo`, therefore `cargo build` is the way to build it.

```bash
cargo build
cargo build --release
```

You have two options to invoke the application (command line interface)

- [1] either, at the root of this repo (/rinex), directly invoke the binary that was generated by the previous step
- [2] or, inside the application folder (/rinex/rinex-cli), using `cargo run`

```bash
# [1]
cd ../
./target/debug/rinex-cli --help
./target/release/rinex-cli --help

# [2]
cd rinex-cli
cargo run -- --help
``` 

Command line arguments order does not matter for the application.   
(Input) `filepath` is the only mandatory argument, other flags are optional.

Some arguments have an abbreviation:

```bash
cargo run --filepath /tmp/amel010.21g
cargo run -f /tmp/amel010.21g
```

Some arguments support an array of values to be given.
In this case, we use a comma seperated format to this day to describe the values.
Whitespaces are not allowed in the description

```bash
rinex-cli --filepath /tmp/amel010.21g
rinex-cli -f test_resources/OBS/V2/rovn0010.21o,test_resources/OBS/V3/DUTH0630.22O
```

Some arguments, like `filepath` for example, can take an array of values.
In this case, we use comma separated enumeration like this:

```bash
cargo run -f /tmp/amel010.21g,/mnt/CBW100NLD_R_20210010000_01D_MN.rnx
```

## Tool philosophy

Invoke the tool against one or several files.  
Several files might be required based on the operation to perform (`help`).  
All flags are optionnal and can be combined.  
If you request some operation, usually to inspect the internal data (like `epoch` or `sv`),
the tool will not expose the record but will restrict to the requested information.

For example, this command line will expose identified epochs and identified vehicules

```bash
rinex-cli -f /tmp/amel010.21g --epoch --sv
``` 

If no specific data or fields are requested to be displayed, then we expose the record

```bash
rinex-cli -f /tmp/amel010.21g
``` 

`-filter` operations can be conbimed to all operations, and will apply
to all given file(s). For example running this command
will perform the previous operation but on reduced data

```bash
rinex-cli -f /tmp/amel010.21g --epoch --sv-filter R01,G01
``` 

And this command gives a more meaningful record visualization

```bash
rinex-cli -f /tmp/amel010.21g \
      --decimate-interval 00:05:00 \
            --sv-filter G01
``` 

## Output format

This tool uses JSON format to expose data, which makes it easy
to import into other tools. The `--pretty` argument is available
and can be combined to all existing flags, to indent the exposed data,
and make it easier to read

```bash
rinex-cli --pretty -f /tmp/amel010.21g \
      --epoch --sv-filter R01,G01 

rinex-cli -f /tmp/amel010.21g \
      --decimate-interval 00:05:00 \
            --sv-filter G01 --pretty
``` 

## Decimate

To reduce the record size, we use decimation

- either by an integer ratio
- or by a minimum epoch interval ("sampling interval") to respect

Here is an example 
every 30 second, we can reduce the data quantity by 2 with this command

```bash
# print initial epochs
rinex-cli --epoch --pretty -f test_resources/OBS/V2/zegv0010.21o

# reduce
rinex-cli -f test_resources/OBS/V2/zegv0010.21o \
    --decimate-interval 00:01:00
```

## Epoch filter

Some RINEX files like Observation Data 
associate an epoch flag to each epoch.  
A non `Ok` epoch flag describes a special event
or external perturbations that happened at that sampling
date. We provide the following arguments to
easily discard unusual events or focus on them to
figure things out:

* --epoch-ok : will retain only valid epochs (EpochFlag::Ok).
This can be a quick way to reduce the amount of data

* --epoch-nok : will retain only non valid epoch (!EpochFlag::Ok). 

Example :

```bash
cargo run -- -f /tmp/data.obs -c C1C,C2C # huge set
cargo run -- -f /tmp/data.obs --epoch-ok -c C1C,C2C # reduce set 
cargo run -- -f /tmp/data.obs --epoch-nok -c C1C,C2C # focus on weird events 
```

## Satellite vehicule filter

`--sv` is one way to focus on specific Satellite Vehicule or constellation of interest.
Use comma separated description!

Example:

```shell
cargo run -- --filepath /tmp/data.obs --epoch-ok \
    --sv G01,G2,E06,E24,R24
```

Will only retain (all) data that has a EpochFlag::Ok 
from GPS 1+2, GAL 6+24 and GLO 24 vehicules.

## Constellation filter

Constellation filter is not feasible at the moment.
User can only use `sv` filter to do that at the moment.

## LLI : RX condition filter

Observation data might have LLI flags attached to them.  
It is possible to filter data that have a matching LLI flag,
for instance 0x01 means Loss of Lock at given epoch:

```shell
cargo run -- -f /tmp/data.obs --lli 1 --sv R01 > output.txt
```

## SSI: signal "quality" filter

Observation data might have an SSI indication attached to them.
It is possible to filter data according to this value and
retain only data with a certain "quality" attached to them.

For example, with this value, we only retain data with SSI >= 5
that means at least 30 dB SNR 

```shell
cargo run -- -f /tmp/data.obs --ssi 1 --sv R01 > output.txt
```

## Data filter

We use the -c or --code argument to filter data out
and only retain data of interest.

* Observation / meteo data: we use the OBS code directly
* Navigation data: we use the official identification keyword,
refer to the known
[NAV database](https://github.com/gwbres/rinex/blob/main/navigation.json)


Example:

```bash
cargo run -f CBW100NLD_R_20210010000_01D_MN.rnx -c L1C,S1P 
```

## Cumulated filters

Because all arguments can be cumulated, one can 
create efficient data filter and focus on data of interest: 

```bash
cargo run -f CBW100NLD_R_20210010000_01D_MN.rnx \
    --lli 0 # "OK" \
        --ssi 5 # not bad \
            -c C1C,C2C,C1X # PR measurements only :) \
                --sv G01,G2,G24,G25 # GPS focus !
```

## `teqc` operations

This tool supports special operations that only
`teqc` supports at the moment. Therefore,
it can be an efficient alternative to this program.

All of the special operations actually create an output file.

## `Merge` special operation

It is possible to perform merging operations with `-m` or `--merge`, in `teqc` similar fashion.

When merging, if analysis are to be performed, they will be performed on the resulting record.

For example:

```bash
cargo run -f file1.rnx,/tmp/file2.rnx
```

## `Split` special operation

It is possible to split given RINEX files into two.

`Split` has two behaviors

* (1) if given RINEX is a `merged` RINEX (either by `teqc` or this tool),
we split the record at the epoch (timestamps) where records were previously merged

* (2) otherwise, the user is expected to describe a timestamp (`epoch`) 
at which we will split the record.

### Splitting a previously merged record

```bash
# Merge two RINEX together
cargo run -f /tmp/file1.rnx,/tmp/file2.rnx -m --output /tmp/merged.rnx
# Split resulting RINEX
cargon run -f /tmp/merged.rnx --split --output /tmp/split1.rnx,/tmp/split2.rnx 
```

When splitting a merged RINEX, the header section is simply
copied into both results.

### Splitting record

If User provides an `epoch`, the tool will try to locate the
given timestamp and perform `split()` at this date & time.

Two description format are supported, for the user to describe a sampling
timestamp:

* "YYYY-MM-DD HH:MM:SS" : Datetime description and EpochFlag::Ok is assumed
* "YYYY-MM-DD HH:MM:SS X" : Datetime description where X describes the EpochFlag integer value.
Refer to RINEX standards for supported Epoch flag values 

The tool identifies matching timestamp by comparing the datetime field AND
the flag field. They both must match.

Example :

```bash
# Split a previously merged record
cargo run -f /tmp/merged.rnx --split \
    --output /tmp/file1.rnx,/tmp/file2.rnx

# Split a record at specified timestamp,
# don't forget the \" encapsulation \" ;)
cargo run -f /tmp/data.rnx --split "2022-06-03 16:00:00" \
    --output /tmp/file1.rnx,/tmp/file2.rnx

# Split a record at specified timestamp with precise Power Failure event
# don't forget the \" encapsulation \" ;)
cargo run -f /tmp/data.rnx --split "2022-06-03 16:00:00 1" \
    --output /tmp/file1.rnx,/tmp/file2.rnx
```
